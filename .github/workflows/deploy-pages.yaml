name: deploy-pages

on:
  push:
    branches:
    - develop
    # paths:  # With benchmarks set to re-run on any push to develop
    # - docs/**
  pull_request:
    branches:
    - develop
  workflow_dispatch:  # Allows manual triggering of the workflow

# This job installs dependencies, builds the book, and pushes it to `gh-pages`
jobs:
  deploy-book:
    runs-on: ubuntu-latest
    steps:
    - uses: actions/checkout@v2

    # Install dependencies
    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: "3.13"

    - name: Install dependencies
      run: |
        pip install -e ".[docs, develop]"



    # # Fetch the gh-pages branch to get the benchmark files
    # - name: Fetch benchmark files
    #   run: |
    #     # Fetch the gh-pages branch
    #     git fetch origin gh-pages:gh-pages
    #     # Create a temporary directory
    #     mkdir -p temp_bench
    #     # Checkout just the dev/bench directory from gh-pages
    #     git checkout gh-pages -- dev/bench || echo "No existing dev/bench directory"
    #     # Copy the files if they exist
    #     if [ -d "dev/bench" ]; then
    #       cp -r dev/bench/* temp_bench/
    #     fi
    #     # Return to original branch
    #     git checkout -

    # Make a copy of the examples folder within the docs folder
    - name: Copy examples to docs
      working-directory: ${{runner.workspace}}/floris/
      run: |
        rsync -av examples/ docs/examples
        ls docs/examples

    # Run the script examples/_convert_examples_to_notebooks.py
    - name: Convert examples to notebooks
      working-directory: ${{runner.workspace}}/floris/docs/examples/
      run: |
        pwd
        ls
        python _convert_examples_to_notebooks.py

    # Build the book
    - name: Build the book
      working-directory: ${{runner.workspace}}/floris/docs/
      run: |
        jupyter-book build .

    # # Copy benchmark files to the built documentation
    # - name: Copy benchmark files to docs
    #   working-directory: ${{runner.workspace}}/floris/
    #   run: |
    #     mkdir -p docs/_build/html/dev/bench
    #     cp -r temp_bench/* docs/_build/html/dev/bench/ || echo "No benchmark files to copy"

    # Push the book's HTML to github-pages
    - name: GitHub Pages action
      uses: peaceiris/actions-gh-pages@v4.0.0
      with:
        github_token: ${{ secrets.GITHUB_TOKEN }}
        publish_dir: ./docs/_build/html
        # destination_dir: docs


    # - name: Run benchmark
    #   working-directory: ${{runner.workspace}}/floris/
    #   run: |
    #     ls -lah
    #     cd benchmarks
    #     pytest bench.py --benchmark-json output.json

    # # Store benchmark result and create the benchmark pages
    # - name: Store benchmark result
    #   uses: benchmark-action/github-action-benchmark@v1
    #   with:
    #     name: Python Benchmark with pytest-benchmark
    #     tool: 'pytest'
    #     output-file-path: benchmarks/output.json
    #     github-token: ${{ secrets.GITHUB_TOKEN }}
    #     auto-push: true
